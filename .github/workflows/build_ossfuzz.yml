# Build OSSFuzz fuzz targets from source.
name: build_ossfuzz
on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - develop
permissions: read-all
jobs:
  build_ossfuzz:
    if: true
    runs-on: ubuntu-22.04
    steps:
    - name: Install build dependencies
      run: |
        sudo apt-get -y install git

    # Check out the current branch of Sleuthkit triggering the workflow
    - name: Check out current branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Ensure the full branch history is fetched

    # Check out the OSS-Fuzz repository into a subdirectory
    - name: Check out OSS-Fuzz repository
      uses: actions/checkout@v4
      with:
        repository: google/oss-fuzz
        path: oss-fuzz

    # Replace the remote pull with the local code
    - name: Inject local Sleuthkit code into OSS-Fuzz build
      run: |
        mv . oss-fuzz/projects/sleuthkit/repo  # Move the current repository to replace the default cloned repo

    # Build OSSFuzz fuzz targets
    - name: Build OSSFuzz fuzz targets
      working-directory: oss-fuzz
      run: |
        # Work around hardcoded -Werror flags
        sed 's?./tsk/util/??' -i projects/sleuthkit/build.sh
        sed 's?./tsk/pool/??' -i projects/sleuthkit/build.sh
        sed 's?--without-libvmdk?--without-libvmdk --without-libcrypto?' -i projects/sleuthkit/build.sh

        # Build using the injected local repository
        python3 infra/helper.py build_image sleuthkit
        python3 infra/helper.py build_fuzzers --sanitizer address sleuthkit
        python3 infra/helper.py check_build sleuthkit
