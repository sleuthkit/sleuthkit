# Build OSSFuzz fuzz targets from source.
name: build_ossfuzz
on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - develop
permissions: read-all
jobs:
  build_ossfuzz:
    if: true
    runs-on: ubuntu-22.04
    steps:
    - name: Install build dependencies
      run: |
        sudo apt-get -y install git

    # Check out the current repository branch triggering the workflow
    - name: Check out current branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Ensure the full history is fetched for the current branch

    # Check out the OSS-Fuzz repository into a subdirectory
    - name: Check out OSS-Fuzz repository
      uses: actions/checkout@v4
      with:
        repository: google/oss-fuzz
        path: oss-fuzz

    # Build OSSFuzz fuzz targets using the local checkout
    - name: Build OSSFuzz fuzz targets
      working-directory: oss-fuzz
      env:
        LOCAL_CHECKOUT: /github/workspace  # Point to the current branch
      run: |
        # Work around hardcoded -Werror flags
        sed 's?./tsk/util/??' -i projects/sleuthkit/build.sh
        sed 's?./tsk/pool/??' -i projects/sleuthkit/build.sh
        sed 's?--without-libvmdk?--without-libvmdk --without-libcrypto?' -i projects/sleuthkit/build.sh

        # Use the local checkout instead of the default remote branch
        python3 infra/helper.py build_image sleuthkit
        python3 infra/helper.py build_fuzzers --sanitizer address sleuthkit
        python3 infra/helper.py check_build sleuthkit
